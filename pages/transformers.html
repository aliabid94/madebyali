<!DOCTYPE html>
<html lang="en">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WM5YFXBNP2"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-WM5YFXBNP2');
    </script>    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformers - madebyali</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="/static/styles.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
</head>

<body class="transformers w-full relative min-h-screen flex flex-col">
    <nav class="mx-auto container px-4 flex pt-4 justify-between items-center w-full">
        <a href="/"><img src="/static/logo.png" class="h-5 sm:h-6 dark:invert"></a>
        <div>
            <h1 class="text-md text-center text-xl">transformers</h1>
            <div class="text-xs text-gray-500 dark:text-gray-400">
                <span id="date"></span> puzzle: <span id="timer">--:--</span>
            </div>
        </div>
        <button id="howToPlayBtn" class="outline-none hover:underline text-xs sm:text-base">how to play</button>
    </nav>
    <main class="mx-auto container px-4 flex-1 flex items-center justify-center">
        <div id="gameContainer" class="w-full max-w-md">
            <!-- Words will be dynamically generated here -->
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50">
        <div
            class="bg-white dark:bg-gray-900 rounded p-8 min-w-96 max-w-md max-h-full overflow-y-auto mx-4 relative text-sm">
            <button id="closeModal"
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-5xl">&times;</button>

            <div id="instructionsContent">
                <h2 class="text-lg mb-4">how to play transformers</h2>
                <p class="mb-3">You'll create a chain of words, given the first and last words of the chain. Fill in the middle words with valid transformations between them.</p>


                <p class="mb-3"><strong>Valid transformations:</strong></p>
                <ul class="list-disc list-inside mb-3">
                    <li>Insert a letter: CAT → CART</li>
                    <li>Remove a letter: CART → ART</li>
                    <li>Swap a letter: ART → ARE</li>
                    <li>Rearrange letters: ARE → EAR</li>
                </ul>

                <p class="mb-3">Circles next to a word indicate if it is a valid word, and between words indicate if the transformation is valid. Green means valid, and red means invalid.</p>
                <p class="mb-3">When all the circles are green, you win!</p>
            </div>

            <div id="completionContent" class="hidden">
                <p class="mb-4">You completed today's transformers puzzle!</p>
                <p class="font-semibold">Time: <span id="completionTime"></span></p>
                <p class="font-semibold">Streak: <span id="completionStreak"></span></p>
            </div>
        </div>
    </div>

    <div
        class="keyboard sticky bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 bg-opacity-50 dark:bg-opacity-50 z-20">
        <div class="max-w-xl mx-auto">
            <div class="grid grid-cols-10 gap-1 sm:gap-2 mb-2">
                <button class="key" data-key="q">Q</button>
                <button class="key" data-key="w">W</button>
                <button class="key" data-key="e">E</button>
                <button class="key" data-key="r">R</button>
                <button class="key" data-key="t">T</button>
                <button class="key" data-key="y">Y</button>
                <button class="key" data-key="u">U</button>
                <button class="key" data-key="i">I</button>
                <button class="key" data-key="o">O</button>
                <button class="key" data-key="p">P</button>
            </div>
            <div class="grid grid-cols-9 gap-1 sm:gap-2 mb-2 px-4">
                <button class="key" data-key="a">A</button>
                <button class="key" data-key="s">S</button>
                <button class="key" data-key="d">D</button>
                <button class="key" data-key="f">F</button>
                <button class="key" data-key="g">G</button>
                <button class="key" data-key="h">H</button>
                <button class="key" data-key="j">J</button>
                <button class="key" data-key="k">K</button>
                <button class="key" data-key="l">L</button>
            </div>
            <div class="grid grid-cols-8 gap-1 sm:gap-2 px-8">
                <button class="key" data-key="z">Z</button>
                <button class="key" data-key="x">X</button>
                <button class="key" data-key="c">C</button>
                <button class="key" data-key="v">V</button>
                <button class="key" data-key="b">B</button>
                <button class="key" data-key="n">N</button>
                <button class="key" data-key="m">M</button>
                <button class="key" data-key="backspace">⌫</button>
            </div>
        </div>
    </div>

    <script>
        // timer and game state management
        const gamename = "transformers";

        const timerSpan = document.getElementById('timer');
        let startTime = Date.now();
        let elapsedTime = 0;
        let timerInterval;
        let isTimerRunning = false;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayString = today.toLocaleDateString('en-US');
        const gameKey = `${gamename}-${todayString}`;
        const visitedKey = `${gamename}-visited`;
        const completionsKey = `${gamename}-completions`;

        const firstDay = new Date('2025-09-29');
        firstDay.setHours(0, 0, 0, 0);
        const daysSinceFirstDay = Math.floor((today - firstDay) / (1000 * 60 * 60 * 24));

        let gameState = localStorage.getItem(gameKey);
        if (gameState) {
            gameState = JSON.parse(gameState);
            elapsedTime = gameState.elapsedTime || 0;
        } else {
            elapsedTime = 0;
            gameState = {
                elapsedTime: 0,
                complete: false,
                currentWords: [],
            };
        }
        let visitedState = localStorage.getItem(visitedKey);
        if (!visitedState) {
            localStorage.setItem(visitedKey, 'true');
        }
        let completionsState = localStorage.getItem(completionsKey);
        if (completionsState) {
            completionsState = JSON.parse(completionsState);
        } else {
            completionsState = [];
        }

        function setGameState(key, value) {
            gameState[key] = value;
            localStorage.setItem(gameKey, JSON.stringify(gameState));
        }

        // modal management
        const modal = document.getElementById('modal');
        const howToPlayBtn = document.getElementById('howToPlayBtn');
        const closeModalBtn = document.getElementById('closeModal');

        function showModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            stopTimer();
        }

        function hideModal() {
            modal.classList.remove('flex');
            modal.classList.add('hidden');

            document.getElementById('instructionsContent').classList.remove('hidden');
            document.getElementById('completionContent').classList.add('hidden');

            if (!gameState.complete) startTimer();
        }

        function showCompletionModal() {
            const minutes = Math.floor(gameState.elapsedTime / 60);
            const seconds = gameState.elapsedTime % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('instructionsContent').classList.add('hidden');
            document.getElementById('completionContent').classList.remove('hidden');

            document.getElementById('completionTime').textContent = timeString;

            if (!completionsState.includes(todayString)) completionsState.push(todayString);
            localStorage.setItem(completionsKey, JSON.stringify(completionsState));
            let streak = 0;
            let currentDate = new Date();
            for (let i = completionsState.length - 1; i >= 0; i--) {
                const completionDate = new Date(completionsState[i]);
                if ((currentDate - completionDate) / (1000 * 60 * 60 * 24) < 1) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }

            document.getElementById('completionStreak').textContent = `${streak} day${streak !== 1 ? 's' : ''}`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        if (!visitedState) {
            showModal();
        }

        howToPlayBtn.addEventListener('click', showModal);
        closeModalBtn.addEventListener('click', hideModal);

        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                hideModal();
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                hideModal();
            }
        });

        // date & timer display
        const dateSpan = document.getElementById('date');
        const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun',
            'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
        const formattedDate = months[today.getMonth()] + ' ' + today.getDate();
        dateSpan.textContent = formattedDate;

        function printTimer() {
            const minutes = Math.floor(gameState.elapsedTime / 60);
            const seconds = gameState.elapsedTime % 60;
            timerSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        printTimer();

        function updateTimer() {
            setGameState('elapsedTime', gameState.elapsedTime + 1);
            printTimer();
        }

        function startTimer() {
            if (!isTimerRunning) {
                timerInterval = setInterval(updateTimer, 1000);
                isTimerRunning = true;
            }
        }

        function stopTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }
        }

        if (!gameState.complete && visitedState) {
            startTimer();
        }

        // game mechanics
        let game;
        let selectedLetterIndex = null;
        let currentWords = [];
        let validWords = new Set();

        Promise.all([
            fetch('/static/transformer-valid-words.json').then(response => response.json()),
            fetch('/static/transformer-games.json').then(response => response.json())
        ]).then(([validWordsData, gamesData]) => {
            validWords = new Set(validWordsData.map(word => word.toLowerCase()));
            game = gamesData[daysSinceFirstDay % gamesData.length];
            initializeGame();
        });

        function initializeGame() {
            if (gameState.currentWords && gameState.currentWords.length > 0) {
                currentWords = gameState.currentWords;
            } else {
                currentWords = game.map((word, i) => {
                    if (i === 0 || i === game.length - 1) {
                        return word.split('');
                    } else {
                        return Array(word.length).fill('');
                    }
                });
                setGameState('currentWords', currentWords);
            }

            renderGame();

            if (!gameState.complete) {
                selectNextEmptyLetter();
            }
        }

        function renderGame() {
            const container = document.getElementById('gameContainer');
            container.innerHTML = '';

            for (let i = 0; i < currentWords.length; i++) {
                const wordContainer = document.createElement('div');
                wordContainer.className = 'flex justify-center items-center gap-2 mb-2';

                const wordDiv = document.createElement('div');
                wordDiv.className = 'flex justify-center gap-1';

                for (let j = 0; j < currentWords[i].length; j++) {
                    const letterBox = document.createElement('div');
                    letterBox.className = 'w-10 h-10 border-2 border-gray-300 dark:border-gray-500 rounded flex items-center justify-center text-lg font-semibold uppercase';

                    const isFirstOrLast = i === 0 || i === currentWords.length - 1;
                    if (isFirstOrLast) {
                        letterBox.classList.add('bg-gray-100', 'dark:bg-gray-700');
                    } else {
                        letterBox.classList.add('cursor-pointer', 'hover:bg-gray-50', 'dark:hover:bg-gray-800');
                        letterBox.dataset.wordIndex = i;
                        letterBox.dataset.letterIndex = j;
                        letterBox.addEventListener('click', handleLetterClick);
                    }

                    letterBox.textContent = currentWords[i][j];

                    if (selectedLetterIndex && selectedLetterIndex.word === i && selectedLetterIndex.letter === j) {
                        letterBox.classList.add('border-pink-500', 'dark:border-pink-400');
                    }

                    wordDiv.appendChild(letterBox);
                }

                wordContainer.appendChild(wordDiv);

                const wordValidationCircle = document.createElement('div');
                wordValidationCircle.className = 'w-4 h-4 rounded-full';

                const wordValidationState = validateWord(currentWords[i]);
                if (wordValidationState === 'valid') {
                    wordValidationCircle.classList.add('bg-green-500');
                } else if (wordValidationState === 'invalid') {
                    wordValidationCircle.classList.add('bg-red-500');
                } else {
                    wordValidationCircle.classList.add('bg-gray-300', 'dark:bg-gray-600');
                }

                wordContainer.appendChild(wordValidationCircle);
                container.appendChild(wordContainer);

                if (i < currentWords.length - 1) {
                    const circleDiv = document.createElement('div');
                    circleDiv.className = 'flex justify-center my-1';

                    const circle = document.createElement('div');
                    circle.className = 'w-4 h-4 rounded-full';

                    const validationState = validateTransformation(currentWords[i], currentWords[i + 1]);
                    if (validationState === 'valid') {
                        circle.classList.add('bg-green-500');
                    } else if (validationState === 'invalid') {
                        circle.classList.add('bg-red-500');
                    } else {
                        circle.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    }

                    circleDiv.appendChild(circle);
                    container.appendChild(circleDiv);
                }
            }

            checkWinCondition();
        }

        function validateWord(word) {
            if (word.includes('')) {
                return 'incomplete';
            }

            const wordStr = word.join('').toLowerCase();

            if (validWords.has(wordStr)) {
                return 'valid';
            } else {
                return 'invalid';
            }
        }

        function validateTransformation(word1, word2) {
            if (word1.includes('') || word2.includes('')) {
                return 'incomplete';
            }

            const w1 = word1.join('').toLowerCase();
            const w2 = word2.join('').toLowerCase();

            if (w1 === w2) {
                return 'invalid';
            }

            // Check for rearrangement (anagram)
            if (w1.split('').sort().join('') === w2.split('').sort().join('')) {
                return 'valid';
            }

            // Check for insertion (w2 has one more letter)
            if (w2.length === w1.length + 1) {
                for (let i = 0; i < w2.length; i++) {
                    const testWord = w2.slice(0, i) + w2.slice(i + 1);
                    if (testWord === w1) {
                        return 'valid';
                    }
                }
            }

            // Check for deletion (w1 has one more letter)
            if (w1.length === w2.length + 1) {
                for (let i = 0; i < w1.length; i++) {
                    const testWord = w1.slice(0, i) + w1.slice(i + 1);
                    if (testWord === w2) {
                        return 'valid';
                    }
                }
            }

            // Check for swap (same length, one letter different)
            if (w1.length === w2.length) {
                let differences = 0;
                for (let i = 0; i < w1.length; i++) {
                    if (w1[i] !== w2[i]) {
                        differences++;
                    }
                }
                if (differences === 1) {
                    return 'valid';
                }
            }

            return 'invalid';
        }

        function handleLetterClick(e) {
            const wordIndex = parseInt(e.target.dataset.wordIndex);
            const letterIndex = parseInt(e.target.dataset.letterIndex);

            selectedLetterIndex = { word: wordIndex, letter: letterIndex };
            renderGame();
        }

        function selectNextEmptyLetter() {
            // Find first empty letter that's not in first or last word
            for (let i = 1; i < currentWords.length - 1; i++) {
                for (let j = 0; j < currentWords[i].length; j++) {
                    if (currentWords[i][j] === '') {
                        selectedLetterIndex = { word: i, letter: j };
                        renderGame();
                        return;
                    }
                }
            }

            // If no empty letters, select first editable letter
            if (currentWords.length > 2) {
                selectedLetterIndex = { word: 1, letter: 0 };
                renderGame();
            }
        }

        function handleKeyPress(key) {
            if (!selectedLetterIndex || gameState.complete) return;

            const { word, letter } = selectedLetterIndex;

            if (key === 'backspace') {
                currentWords[word][letter] = '';
                setGameState('currentWords', currentWords);

                // Move cursor backward
                moveSelection('left');
                return;
            } else if (/^[a-z]$/.test(key)) {
                currentWords[word][letter] = key;
                setGameState('currentWords', currentWords);

                // Move to next letter
                let nextWord = word;
                let nextLetter = letter + 1;

                if (nextLetter >= currentWords[word].length) {
                    nextWord++;
                    nextLetter = 0;
                }

                // Skip first and last words
                if (nextWord >= currentWords.length - 1) {
                    nextWord = 1;
                    nextLetter = 0;
                }

                selectedLetterIndex = { word: nextWord, letter: nextLetter };
                renderGame();
            }
        }

        function moveSelection(direction) {
            if (!selectedLetterIndex) return;

            let { word, letter } = selectedLetterIndex;

            if (direction === 'left') {
                letter--;
                if (letter < 0) {
                    word--;
                    if (word < 1) word = currentWords.length - 2;
                    letter = currentWords[word].length - 1;
                }
            } else if (direction === 'right') {
                letter++;
                if (letter >= currentWords[word].length) {
                    word++;
                    if (word >= currentWords.length - 1) word = 1;
                    letter = 0;
                }
            } else if (direction === 'up') {
                word--;
                if (word < 1) word = currentWords.length - 2;
                if (letter >= currentWords[word].length) letter = currentWords[word].length - 1;
            } else if (direction === 'down') {
                word++;
                if (word >= currentWords.length - 1) word = 1;
                if (letter >= currentWords[word].length) letter = currentWords[word].length - 1;
            }

            selectedLetterIndex = { word, letter };
            renderGame();
        }

        function checkWinCondition() {
            // Check if all circles are green (all transformations valid)
            let allValid = true;
            for (let i = 0; i < currentWords.length - 1; i++) {
                if (validateTransformation(currentWords[i], currentWords[i + 1]) !== 'valid') {
                    allValid = false;
                    break;
                }
            }

            if (allValid && !gameState.complete) {
                setGameState('complete', true);
                handleGameCompletion();
            }
        }

        function handleGameCompletion() {
            stopTimer();
            document.querySelector(".keyboard").classList.add('hidden');
            showCompletionModal();
        }

        if (gameState.complete) {
            handleGameCompletion();
        }

        // Keyboard event listeners
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('key')) {
                const key = e.target.getAttribute('data-key');
                handleKeyPress(key);
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            if (e.key === 'Escape' || modal.classList.contains('flex')) return;

            if (e.key === 'Backspace') {
                e.preventDefault();
                handleKeyPress('backspace');
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                moveSelection('left');
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                moveSelection('right');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                moveSelection('up');
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                moveSelection('down');
            } else if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
                e.preventDefault();
                handleKeyPress(e.key.toLowerCase());
            }
        });
    </script>
</body>

</html>
